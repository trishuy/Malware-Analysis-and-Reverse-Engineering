# DemoAnalysisMalware

1.	Mã độc có bị pack hay không? Chỉ ra 2 dấu hiệu (kết quả phân tích trên 2 công cụ khác nhau) chứng minh.

Đầu tiên dò trên PeID file gốc xem file có bị pack hay chưa và nó cho kết quả là  

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/6bc62cc7-3d11-40f5-a444-4fdeeb477ae5)

	Như vậy là file chưa bị pack cũng như tra trên mạng thì file là legit

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/b3b30f2b-917d-4a9b-bd3d-03cd91c8747c)

 
Vì mình mới chỉ dò qua file gốc nên không biết nó như nào nên em tìm OEP của nó và ra kết quả là 

 ![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/76d5d80f-bee0-4550-a875-fa0505b41d5d)


Sau đấy sẽ pack file này để giải nén dữ liệu gốc trước khi file thực sự được thực thi vì 
- File sẽ được thực thi ở một OEP (Original Entry Point) mới ( đoạn code được đưa vào cuối file khi Pack)
- Nó sẽ lưu lại trạng thái của các thanh ghi hiện tại bằng lệnh PUSHAD.
- Toàn bộ nội dung được Pack sẽ được giải nén.
- “Import table” sẽ được sửa lại cho đúng với file thực thi ban đầu
- Giá trị các thanh ghi được lưu lại trước đó sẽ được khôi phục bằng lệnh POPAD.
- EIP nhảy đến OEP của file trước khi Pack, lúc này chương trình sẽ chính thức được thực thi. 
=> Sẽ pack bằng UPX và ta có được file sau  ```

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/dcbea778-1cf2-4821-927e-d0811715ee34)

Bây giờ chúng ta load nó vào Olly để debug tìm OEP thực sự của nó

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/fb358238-fa2d-4751-b196-ef86cf34cfac)

câu lệnh ```PUSHAD``` và ```POPAD```. Thường là 2 câu lệnh bắt đầu và kết thúc công việc giải mã đoạn code thực thi của chương trình gốc.

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/8ca1cdb8-0180-42e6-bb86-56a31a4becd2)

Nhưng ở đây khi thực thi 2 câu lệnh này thì ta không thấy ở comment để dẫn đến đoạn code OEP

```=> Khả năng cao là file chưa bị pack ```

Kiểm tra thêm trên IAT và LordPE thì file không thực thi kể cả mình chạy file

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/4d3506c8-d502-4e82-8afc-b2f7f4aa6f57)

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/f4ddfa72-e686-4677-9bd8-4f1ade558575)

```=> Mã độc không bị pack ```

2. Mã độc thực hiện hành vi gì? (hành vi về mạng, hành vi tạo/sửa/xóa file, hành vi thay đổi registry, lây nhiễm vào đâu….) Với mỗi hành vi minh chứng bằng kết quả phân tích tĩnh và phân tích động.
+ Về Phân tích tĩnh :
Sử dụng  MIA để kiểm tra cũng như sử dụng để tạo dấu hiệu   YARA rules để kiểm tra mã độc Lab07-02.exe

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/5c6b22c7-3122-4525-89cb-7764fff7d63b)

 
Có thể thấy trong blacklist ta có UPX0 -3 và virtualprotect => trong lúc Pack Bằng UPX thì nó sinh ra trong Lab07-02 
Virtualprotect tra được trên mạng thì nó cho kết quả là Win32 

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/b4493f6c-2a45-43ac-b189-f1fe2c8967eb)

+ Về Phân tích động  :
Sau khi chạy thử file unpack và pack nhận được kết quả đó chính là

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/a8f705a4-5050-4c2b-9110-aa2d496069b9)

Có vẻ như đây là 
Chương trình hiển thị một trang web quảng cáo cho người dùng.
Chương trình kết thúc thực thi sau khi hiển thị quảng cáo.

```=>	Mã Độc thực hiện hành vi về mạng``` 


3.Sử dụng hệ thống sandbox phân tích lại mã độc và đối chiếu với kết quả của yêu cầu 1, 2
Sử dụng sandbox thì giống với cái phân tích động 
Chương trình hiển thị một trang web quảng cáo cho người dùng.
Chương trình kết thúc thực thi sau khi hiển thị quảng cáo

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/85f7603a-c060-45b5-9e68-3929c2e1774e)

![image](https://github.com/trishuy/Malware-Analysis-and-Reverse-Engineering/assets/95763623/6ccb70ec-c75b-4e0e-b444-b90545d808b0)

  

4.Tạo dấu hiệu nhận dạng trên YARA với mã độc trên.
```
Rule Lab07-02_ru
{
meta :
            Description = “Detects Rule Lab07-02_ru”
            Author = “Markus & Laszlo”
            Reference = “www.malwareanalysisbook.com/ad.html” 
            Hash = “3f050d40174517359bd590c0e6ab7448”
            Date = “Sun Dec 19 08:18:04 2010”
strings:
            $mz  = { 4d 5a}
            $s1   =   “UPX0”
            $s2   =   “UPX1”
            $s3   =   “UPX3”
           $s4    =   “www.malwareanalysisbook.com/ad.html” 

condition:
            ($mz at 0, $s1  or $s2 or $s3 or $s4 )
}
```
